{{- /*
  Render Blog Post OG Image with Title
  This generates an SVG with the blog post title for use as OG image
  SVG is converted to a Hugo resource that can be referenced
*/ -}}

{{- $pageTitle := .Title }}
{{- $pageDate := "" }}
{{- if .Date }}
  {{- $pageDate = .Date.Format "January 2, 2006" }}
{{- end }}
{{- $author := .Params.author | default "" }}

{{- /* Word wrap the title for better display */ -}}
{{- $titleLines := slice }}
{{- $words := split $pageTitle " " }}
{{- $currentLine := "" }}
{{- $maxCharsPerLine := 35 }}

{{- range $words }}
  {{- $testLine := printf "%s %s" $currentLine . }}
  {{- if gt (len $testLine) $maxCharsPerLine }}
    {{- if ne $currentLine "" }}
      {{- $titleLines = $titleLines | append $currentLine }}
    {{- end }}
    {{- $currentLine = . }}
  {{- else }}
    {{- $currentLine = $testLine }}
  {{- end }}
{{- end }}
{{- if ne $currentLine "" }}
  {{- $titleLines = $titleLines | append (trim $currentLine " ") }}
{{- end }}

{{- /* Limit to 3 lines */ -}}
{{- if gt (len $titleLines) 3 }}
  {{- $line3 := index $titleLines 2 }}
  {{- if gt (len $line3) 30 }}
    {{- $line3 = printf "%s..." (substr $line3 0 27) }}
  {{- end }}
  {{- $titleLines = slice (index $titleLines 0) (index $titleLines 1) $line3 }}
{{- end }}

{{- /* Calculate vertical positioning for title */ -}}
{{- $startY := 180 }}
{{- if eq (len $titleLines) 1 }}
  {{- $startY = 280 }}
{{- else if eq (len $titleLines) 2 }}
  {{- $startY = 240 }}
{{- end }}

{{- /* Build the SVG */ -}}
{{- /* Get absolute URL for logo */ -}}
{{- $logoURL := "/images/validated-patterns.png" | absURL }}

{{- $svgContent := printf `<svg width="1200" height="630" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <defs>
    <linearGradient id="mainGradient" x1="0%%" y1="0%%" x2="100%%" y2="100%%">
      <stop offset="0%%" style="stop-color:#0066CC;stop-opacity:1" />
      <stop offset="50%%" style="stop-color:#004080;stop-opacity:1" />
      <stop offset="100%%" style="stop-color:#002952;stop-opacity:1" />
    </linearGradient>
    <pattern id="dots" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
      <circle cx="2" cy="2" r="1" fill="rgba(255,255,255,0.1)" />
    </pattern>
  </defs>
  
  <!-- Background -->
  <rect width="1200" height="630" fill="url(#mainGradient)"/>
  <rect width="1200" height="630" fill="url(#dots)"/>
  
  <!-- Decorative elements -->
  <rect x="0" y="0" width="8" height="630" fill="#0066CC" opacity="0.8"/>
  <rect x="0" y="0" width="1200" height="8" fill="#0066CC" opacity="0.8"/>
  
  <!-- Validated Patterns Logo (centered, top) -->
  <image xlink:href="%s" x="420" y="40" width="360" height="55" opacity="1.0"/>
  
  <!-- Title (dynamically positioned) -->` $logoURL }}

{{- range $idx, $line := $titleLines }}
  {{- $yPos := add $startY (mul $idx 65) }}
  {{- $svgContent = printf `%s
  <text x="60" y="%d" font-family="Red Hat Display, Arial, sans-serif" font-size="52" font-weight="700" fill="white">%s</text>` $svgContent $yPos (htmlEscape $line) }}
{{- end }}

{{- /* Add metadata */ -}}
{{- $svgContent = printf `%s
  
  <!-- Metadata -->` $svgContent }}

{{- if $pageDate }}
  {{- $svgContent = printf `%s
  <text x="60" y="520" font-family="Red Hat Display, Arial, sans-serif" font-size="24" font-weight="400" fill="white" opacity="0.8">%s</text>` $svgContent (htmlEscape $pageDate) }}
{{- end }}

{{- if $author }}
  {{- $svgContent = printf `%s
  <text x="60" y="555" font-family="Red Hat Display, Arial, sans-serif" font-size="22" font-weight="400" fill="white" opacity="0.7">by %s</text>` $svgContent (htmlEscape $author) }}
{{- end }}

{{- /* Brand name */ -}}
{{- $svgContent = printf `%s
  
  <!-- Brand -->
  <line x1="60" y1="575" x2="300" y2="575" stroke="white" stroke-width="2" opacity="0.5"/>
  <text x="60" y="605" font-family="Red Hat Display, Arial, sans-serif" font-size="20" font-weight="600" fill="white" opacity="0.9">Validated Patterns Blog</text>
</svg>` $svgContent }}

{{- /* Create the resource */ -}}
{{- $filename := printf "og-images/blog/%s.svg" .File.ContentBaseName }}
{{- $resource := $svgContent | resources.FromString $filename }}

{{- /* Return the permalink */ -}}
{{- return $resource.Permalink }}

