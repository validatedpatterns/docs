{{- /*
  Advanced OG Image Generator with Text Overlay
  This requires Hugo Extended version with image filter support
  Creates branded OG images with the post title overlaid on a base image
*/ -}}

{{- $ogImage := "" }}
{{- $pageTitle := .Title }}
{{- $truncatedTitle := $pageTitle }}
{{- if gt (len $pageTitle) 80 }}
  {{- $truncatedTitle = printf "%s..." (substr $pageTitle 0 77) }}
{{- end }}

{{- /* Check for custom image in front matter */ -}}
{{- if .Params.og_image }}
  {{- with resources.Get .Params.og_image }}
    {{- $ogImage = . }}
  {{- else }}
    {{- $ogImage = .Params.og_image | absURL }}
  {{- end }}
{{- else if .Params.image }}
  {{- with resources.Get .Params.image }}
    {{- /* Resize custom image to OG dimensions */ -}}
    {{- $ogImage = .Resize "1200x630 Center" }}
  {{- else }}
    {{- $ogImage = .Params.image | absURL }}
  {{- end }}
{{- else if .Params.featured_image }}
  {{- with resources.Get .Params.featured_image }}
    {{- $ogImage = .Resize "1200x630 Center" }}
  {{- else }}
    {{- $ogImage = .Params.featured_image | absURL }}
  {{- end }}
{{- end }}

{{- /* Generate dynamic image for blog posts without custom images */ -}}
{{- if and (not $ogImage) (eq .Section "blog") }}
  {{- /* Try to get a base template image */ -}}
  {{- $baseImage := resources.Get "images/og-template-base.png" }}
  
  {{- if not $baseImage }}
    {{- /* Fallback: use the site logo as base */ -}}
    {{- $baseImage = resources.Get "images/validated-patterns.png" }}
  {{- end }}
  
  {{- if $baseImage }}
    {{- /* Resize to OG dimensions */ -}}
    {{- $resized := $baseImage.Fit "1200x630" }}
    
    {{- /* Apply filters for a nice background effect */ -}}
    {{- $processed := $resized }}
    {{- $processed = $processed.Filter (images.Brightness 10) }}
    {{- $processed = $processed.Filter (images.Contrast 10) }}
    
    {{- /* Note: Text overlay would require Hugo Extended with overlay filter
         For now, we create a visually appealing base image
         Consider using external service or pre-generated templates for text */ -}}
    
    {{- /* Store the processed image */ -}}
    {{- $filename := printf "og-generated/%s.jpg" .File.ContentBaseName }}
    {{- $ogImage = $processed }}
  {{- end }}
{{- end }}

{{- /* Ultimate fallback */ -}}
{{- if not $ogImage }}
  {{- $ogImage = resources.Get "images/validated-patterns.png" }}
  {{- if $ogImage }}
    {{- $ogImage = $ogImage.Resize "1200x630" }}
  {{- end }}
{{- end }}

{{- /* Return the image permalink or URL */ -}}
{{- if $ogImage }}
  {{- if reflect.IsMap $ogImage }}
    {{- return $ogImage.Permalink }}
  {{- else }}
    {{- return $ogImage }}
  {{- end }}
{{- else }}
  {{- return (.Site.Params.site_logo | absURL) }}
{{- end }}

