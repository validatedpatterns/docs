<!doctype html><html><head><link rel=stylesheet href=https://docs-ng.hybrid-cloud-patterns.io/sass/patternfly.css><link rel=stylesheet href=https://docs-ng.hybrid-cloud-patterns.io/sass/patternfly-addons.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/solid.css><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.7.2/css/fontawesome.css><link rel=stylesheet href=/css/custom.css><title>Imperative Actions | Hybrid Cloud Patterns - NG Site</title></head><body><div class=pf-c-page><header class=pf-c-page__header><div class=pf-c-page__header-brand><a href=/ class=pf-c-page__header-brand-link><img src=/images/hybrid_cloud_patterns.png alt="Hybrid Cloud Patterns - NG Site"></a></div><div class=pf-c-page__header-tools><nav class="pf-c-nav pf-m-horizontal" role=navigation><ul class=pf-c-nav__list><li class="pf-c-nav__item pf-m-current"><a class=pf-c-nav__link href=/patterns/ title=Patterns>Patterns</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/learn/ title=Learn>Learn</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/contribute/ title=Contribute>Contribute</a></li><li class=pf-c-nav__item><a class=pf-c-nav__link href=/blog/ title=Blog>Blog</a></li></ul></nav></div></header><div class=pf-c-page__sidebar><div class=pf-c-page__sidebar-body><div class=pf-c-nav><ul class=pf-c-nav__list><li class=pf-c-nav__item><a href=/patterns/ class=pf-c-nav__link><span class="pf-c-icon pf-m-md pf-m-inline"><span class=pf-c-icon__content><i class="fas fa-angle-left" aria-hidden=true></i></span></span>
<span style=padding-left:10px>Back to Patterns</span></a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/ class=pf-c-nav__link>Multicloud GitOps</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/getting-started/ class=pf-c-nav__link>Getting Started</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/managed-cluster/ class=pf-c-nav__link>Managed cluster sites</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/cluster-sizing/ class=pf-c-nav__link>Cluster Sizing</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/imperative-actions/ class="pf-c-nav__link pf-m-current">Imperative Actions</a></li><li class="pf-c-nav__item pf-m-expanded"><a href=https://docs-ng.hybrid-cloud-patterns.io/patterns/multicloud-gitops/ideas-for-customization/ class=pf-c-nav__link>Ideas for Customization</a></li></ul></div></div></div><main class=pf-c-page__main><section class=pf-c-page__main-section><div class="pf-l-grid pf-m-gutter"><div class="pf-l-grid__item pf-m-8-col"><div class=pf-c-content><div class=pf-c-content><h1 id=imperative-actions-on-the-cluster>Imperative actions on the cluster</h1><h2 id=using-kubernetes-cronjobs-to-execute-imperative-actions>Using kubernetes cronjobs to execute imperative actions</h2><p>There is currently no way within argoCD to apply an imperative action against a cluster. So we have developed a way to declaratively apply changes to a cluster using kubernetes cronjob resources. Customers can use their ansible playbooks to take action against a cluster if necessary.</p><p>As a word of caution - the authors of the ansible playbooks and roles must ensure that the playbooks are idempotent because they get applied through cronjobs which are set to run every 10 minutes. Adding your playbooks to the pattern requires the following:</p><ol><li>move your ansible configurations to the appropriate directory under ansible in your forked repository</li><li>define your job as a list (see example below)</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>imperative</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># NOTE: We *must* use lists and not hashes. As hashes lose ordering once parsed by helm</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># The default schedule is every 10 minutes: imperative.schedule</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Total timeout of all jobs is 1h: imperative.activeDeadlineSeconds</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># imagePullPolicy is set to always: imperative.imagePullPolicy</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># For additional overrides that apply to the jobs, please refer to the README located in</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># the top level of this repository.</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jobs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>regional-ca</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># ansible playbook to be run</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>playbook</span>: <span style=color:#ae81ff>ansible/playbooks/on-hub-get-regional-ca.yml</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># per playbook timeout in seconds</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>timeout</span>: <span style=color:#ae81ff>234</span>
</span></span><span style=display:flex><span>      <span style=color:#75715e># verbosity: &#34;-v&#34;</span>
</span></span></code></pre></div><h2 id=additional-job-customizations>Additional job customizations</h2><p>Overrides have been implemented to allow for further customization, please refer to the list below for the available overrides.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>  <span style=color:#f92672>imperative</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>jobs</span>: []
</span></span><span style=display:flex><span>    <span style=color:#75715e># This image contains ansible + kubernetes.core by default and is used to run the jobs</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>registry.redhat.io/ansible-automation-platform-22/ee-supported-rhel8:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>namespace</span>: <span style=color:#e6db74>&#34;imperative&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># configmap name in the namespace that will contain all helm values</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>valuesConfigMap</span>: <span style=color:#e6db74>&#34;helm-values-configmap&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>cronJobName</span>: <span style=color:#e6db74>&#34;imperative-cronjob&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>jobName</span>: <span style=color:#e6db74>&#34;imperative-job&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>imagePullPolicy</span>: <span style=color:#ae81ff>Always</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># This is the maximum timeout of all the jobs (1h)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>activeDeadlineSeconds</span>: <span style=color:#ae81ff>3600</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># By default we run this every 10minutes</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>schedule</span>: <span style=color:#e6db74>&#34;*/10 * * * *&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Schedule used to trigger the vault unsealing (if explicitely enabled)</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Set to run every 9 minutes in order for load-secrets to succeed within</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># a reasonable amount of time (it waits up to 15 mins)</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>insecureUnsealVaultInsideClusterSchedule</span>: <span style=color:#e6db74>&#34;*/9 * * * *&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Increase ansible verbosity with &#39;-v&#39; or &#39;-vv..&#39;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>verbosity</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>serviceAccountCreate</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># service account to be used to run the cron pods</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>serviceAccountName</span>: <span style=color:#ae81ff>imperative-sa</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clusterRoleName</span>: <span style=color:#ae81ff>imperative-cluster-role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>clusterRoleYaml</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>roleName</span>: <span style=color:#ae81ff>imperative-role</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>roleYaml</span>: <span style=color:#e6db74>&#34;&#34;</span>
</span></span></code></pre></div></div></div></div><div class="pf-l-grid__item pf-m-4-col"><nav class="pf-c-jump-links pf-m-vertical" aria-label=Contents><div class=pf-c-jump-links__main><div class=pf-c-jump-links__header><div class=pf-c-jump-links__label><h1>Table of Contents</h1></div></div><nav id=TableOfContents><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#imperative-actions-on-the-cluster>Imperative actions on the cluster</a><ul class=pf-c-jump-links__list><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#using-kubernetes-cronjobs-to-execute-imperative-actions>Using kubernetes cronjobs to execute imperative actions</a></li><li class=pf-c-jump-links__item><a class=pf-c-jump-links__link href=#additional-job-customizations>Additional job customizations</a></li></ul></li></ul></nav></div></nav></div></div></section></main></div><div><div style=padding:10px;text-align:center;color:#d2d2d2;background-color:#000>Copyright &copy; 2022 Red Hat, Inc.</div></div></body></html>